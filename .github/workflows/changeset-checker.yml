# -------------------------------------------------------------------------------------
#
# Copyright (c) 2023, WSO2 LLC. (https://www.wso2.com).
#
# WSO2 LLC. licenses this file to you under the Apache License,
# Version 2.0 (the "License"); you may not use this file except
# in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied. See the License for the
# specific language governing permissions and limitations
# under the License.
#
# --------------------------------------------------------------------------------------

# This workflow will check if a submitted PR has changesets.

name: ðŸ¦‹ Check for Changeset

# read-write repo token
# access to secrets
on:
    workflow_run:
        workflows: ["Trigger Changeset Checker"]
        types:
            - completed

env:
    GH_TOKEN: ${{ secrets.RELEASE_BOT_TOKEN }}

jobs:
    upload:
        runs-on: ubuntu-latest
        if: >
            github.event.workflow_run.event == 'pull_request' &&
            github.event.workflow_run.conclusion == 'success'
        steps:
            - name: "Download artifact"
              uses: actions/github-script@v3.1.0
              with:
                  script: |
                      var artifacts = await github.actions.listWorkflowRunArtifacts({
                         owner: context.repo.owner,
                         repo: context.repo.repo,
                         run_id: ${{github.event.workflow_run.id }},
                      });
                      var matchArtifact = artifacts.data.artifacts.filter((artifact) => {
                        return artifact.name == "pr"
                      })[0];
                      var download = await github.actions.downloadArtifact({
                         owner: context.repo.owner,
                         repo: context.repo.repo,
                         artifact_id: matchArtifact.id,
                         archive_format: 'zip',
                      });
                      var fs = require('fs');
                      fs.writeFileSync('${{github.workspace}}/pr.zip', Buffer.from(download.data));
            - run: unzip pr.zip

            - name: "Comment on PR"
              uses: actions/github-script@v3
              with:
                  github-token: ${{ env.GH_TOKEN }}
                  script: |
                      var fs = require('fs');
                      var issue_number = Number(fs.readFileSync('./NR'));
                      await github.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: issue_number,
                        body: 'Everything is OK. Thank you for the PR!'
                      });
