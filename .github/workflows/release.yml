name: Release Workflow

on:
    push:
        branches: [improve-release-workflow]
        paths-ignore:
            - "**.md"
            - "LICENSE"
        workflow_dispatch:

env:
    GH_TOKEN: ${{ secrets.RELEASE_BOT_TOKEN }}
    BOT_USERNAME: ${{ secrets.RELEASE_BOT_USER_NAME }}
    BOT_EMAIL: ${{ secrets.RELEASE_BOT_EMAIL }}

jobs:
    release:
        name: ğŸš€ Release
        runs-on: ubuntu-latest
        strategy:
            matrix:
                node-version: [lts/*]
                maven-version: [3.8.6]
                java-version: [1.8]
                pnpm-version: [8.6.0]
        steps:
            - name: â¬‡ï¸ Checkout
              id: checkout
              uses: actions/checkout@v2.3.3
              with:
                  token: ${{ env.GH_TOKEN }}
                  fetch-depth: 0

            - name: ğŸŸ¢ Setup node
              id: setup-node
              uses: actions/setup-node@v2
              with:
                  node-version: ${{ matrix.node-version }}

            - name: â˜• Set up JDK 1.8
              id: jdk-setup
              uses: actions/setup-java@v1
              with:
                  java-version: ${{ matrix.java-version }}

            - name: ğŸ¦© Set up Maven
              uses: stCarolas/setup-maven@v4
              id: mvn-setup
              with:
                  maven-version: ${{ matrix.maven-version }}

            - name: ğŸ¥¡ Setup pnpm
              uses: pnpm/action-setup@v2.1.0
              with:
                  version: ${{ matrix.pnpm-version }}
                  run_install: false

            - name: ğŸˆ Get pnpm store directory
              id: get-pnpm-cache-dir
              run: |
                  echo "::set-output name=pnpm_cache_dir::$(pnpm store path)"

            - name: ğŸ”† Cache pnpm modules
              uses: actions/cache@v3
              id: pnpm-cache
              with:
                  path: ${{ steps.get-pnpm-cache-dir.outputs.pnpm_cache_dir }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: ğŸ§© Install Dependencies
              id: install-dependencies
              run: pnpm install

            - name: ğŸ“ Create settings.xml with Nexus credentials in ~/.m2
              run: |
                  echo '<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                              http://maven.apache.org/xsd/settings-1.0.0.xsd">
                    <servers>
                      <server>
                        <id>nexus-releases</id>
                        <username>${{ secrets.NEXUS_USERNAME }}</username>
                        <password>${{ secrets.NEXUS_PASSWORD }}</password>
                      </server>

                      <server>
                        <id>wso2.releases</id>
                        <username>${{ secrets.NEXUS_USERNAME }}</username>
                        <password>${{ secrets.NEXUS_PASSWORD }}</password>
                      </server>

                      <server>
                        <id>wso2.snapshots</id>
                        <username>${{ secrets.NEXUS_USERNAME }}</username>
                        <password>${{ secrets.NEXUS_PASSWORD }}</password>
                      </server>
                    </servers>
                  </settings>' > ~/.m2/settings.xml

            - name: ğŸ’¾ Cache local Maven repository
              id: cache-maven-m2
              uses: actions/cache@v2
              with:
                  path: ~/.m2/repository
                  key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
                  restore-keys: |
                      ${{ runner.os }}-maven-

            # - name: ğŸ¤– Configure Git user
            #   run: |
            #     git config --global user.name "github-actions[bot]"
            #     git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

            - name: ğŸ“£ Create Release Pull Request or Publish to npm
              id: changesets
              uses: changesets/action@v1
              with:
                title: "[Release] [GitHub Action] Update package versions"
                publish: pnpm publish:packages
                version: pnpm version:packages
                commit: "[WSO2 Release] [GitHub Action] [Release] [skip ci] update package versions"

            # - name: ğŸ“ Check Changeset status
            #   id: check-changeset-status
            #   run: |
            #     pnpm changeset status --output=./.changeset/changeset-status.json
            #     PACKAGES=$(jq -r '.changesets[].releases[].name' ./.changeset/changeset-status.json | paste -sd, -)
            #     echo "Extracted names: $PACKAGES"
            #     echo "::set-output name=extracted_names::$PACKAGES"

            # - name: ğŸš€ Maven Release
            #   id: maven-release
            #   run: mvn -Dresume=false -Darguments='-Dadditionalparam=-Xdoclint:none' -B release:prepare && mvn -Dresume=false -Darguments='-Dadditionalparam=-Xdoclint:none' release:perform --settings ~/.m2/settings.xml

            - name: ğŸš€ Perform Release
              id: perform-release
              working-directory: .github/workflows
              run: |
                  PACKAGES="${{ toJson(steps.changesets.outputs.publishedPackages) }}"
                  bash ./scripts/release.sh "$PACKAGES"
